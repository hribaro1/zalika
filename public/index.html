<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Prihranite čas mi likamo za vas!</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, select { display:block; margin:8px 0; padding:8px; width:300px; max-width:100%; }
    #orders { margin-top: 24px; }
    .order { border:1px solid #ddd; padding:10px; margin-bottom:8px; border-radius:4px; }
    .meta { color:#666; font-size:12px; }
    #placeOrder {
      background: #007bff;
      color: #fff;
      padding: 12px 24px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      transition: background 0.15s ease, transform 0.08s ease;
    }
    #placeOrder:hover { background: #0062cc; transform: translateY(-1px); }
    .small-btn { padding:6px 10px; font-size:13px; margin-left:6px; border-radius:6px; cursor:pointer; }
    .status-select { margin-top:8px; }
  </style>
</head>
<body>
  <h1>Sprejem naročila</h1>

  <input id="name" placeholder="Ime in priimek" />
  <input id="email" placeholder="E-pošta" />
  <input id="phone" placeholder="Telefonska številka" />
  <input id="address" placeholder="Naslov" />
  
  <select id="service">
    <option>Pranje</option>
    <option>Pranje in likanje</option>
    <option>Čistilnica</option>
  </select>

  <button id="placeOrder">Place Order</button>

  <div id="orders">
    <h2>Pregled naročil</h2>
    <div id="ordersList">Nalaganje...</div>
  </div>

  <script>
    const STATUS_OPTIONS = ["Naročeno", "Sprejeto", "V delu", "Končano", "Oddano"];

    function isValidEmail(email) {
      return /.+@.+\..+/.test(email);
    }
    function isValidPhone(phone) {
      return /^[+\d\s\-().]{6,20}$/.test(phone);
    }

    async function loadOrders() {
      const list = document.getElementById('ordersList');
      list.textContent = 'Nalaganje...';
      try {
        const res = await fetch('/orders');
        if (!res.ok) throw new Error('Network response not ok');
        const orders = await res.json();
        if (!orders.length) {
          list.innerHTML = '<i>Ni še nobenih naročil.</i>';
          return;
        }
        list.innerHTML = '';
        orders.forEach(o => {
          const div = document.createElement('div');
          div.className = 'order';
          const created = o.createdAt ? new Date(o.createdAt).toLocaleString() : '';
          
          // Status select
          const statusSelect = document.createElement('select');
          statusSelect.className = 'status-select';
          STATUS_OPTIONS.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.textContent = s;
            if (o.status === s) opt.selected = true;
            statusSelect.appendChild(opt);
          });

          const updateStatusBtn = document.createElement('button');
          updateStatusBtn.textContent = 'Posodobi status';
          updateStatusBtn.className = 'small-btn';
          updateStatusBtn.addEventListener('click', () => updateStatus(o._id, statusSelect.value));

          const editBtn = document.createElement('button');
          editBtn.textContent = 'Uredi';
          editBtn.className = 'small-btn';
          editBtn.addEventListener('click', () => editOrder(o));

          div.innerHTML = `
            <strong>${escapeHtml(o.name)}</strong> — ${escapeHtml(o.service)}<br/>
            <div class="meta">${escapeHtml(o.email)} • ${escapeHtml(o.phone)} • ${escapeHtml(o.address)}${created ? ' • ' + created : ''}</div>
            <div class="meta">Status: <span id="status-${o._id}">${escapeHtml(o.status || 'Naročeno')}</span></div>
          `;
          // append controls
          const controls = document.createElement('div');
          controls.appendChild(statusSelect);
          controls.appendChild(updateStatusBtn);
          controls.appendChild(editBtn);
          div.appendChild(controls);

          list.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        list.innerHTML = '<span style="color:red">Napaka pri nalaganju naročil.</span>';
      }
    }

    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    async function updateStatus(id, status) {
      try {
        const res = await fetch(`/order/${id}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        if (!res.ok) {
          const err = await res.json().catch(() => null);
          throw new Error(err && err.error ? err.error : 'Server error');
        }
        const data = await res.json();
        document.getElementById(`status-${id}`).textContent = data.order.status;
        alert('Status posodobljen.');
      } catch (err) {
        console.error(err);
        alert('Napaka pri posodabljanju statusa. Preverite konzolo.');
      }
    }

    async function editOrder(order) {
      // Simple prompt-based edit (for demo). Could be replaced with modal/form.
      const name = prompt('Ime:', order.name) || order.name;
      const email = prompt('Email:', order.email) || order.email;
      const phone = prompt('Telefon:', order.phone) || order.phone;
      const address = prompt('Naslov:', order.address) || order.address;
      const service = prompt('Storitev:', order.service) || order.service;
      const status = prompt('Status (točno ime):', order.status) || order.status;

      if (!name || !email || !address || !phone) {
        alert('Ime, email, telefon in naslov morajo biti izpolnjeni.');
        return;
      }
      if (!/.+@.+\..+/.test(email)) {
        alert('Neveljaven email.');
        return;
      }
      if (!/^[+\d\s\-().]{6,20}$/.test(phone)) {
        alert('Neveljavna telefonska številka.');
        return;
      }
      if (!STATUS_OPTIONS.includes(status)) {
        alert('Neveljaven status. Dovoljeni so: ' + STATUS_OPTIONS.join(', '));
        return;
      }

      try {
        const res = await fetch(`/order/${order._id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, phone, address, service, status })
        });
        if (!res.ok) {
          const err = await res.json().catch(() => null);
          throw new Error(err && err.error ? err.error : 'Server error');
        }
        alert('Naročilo posodobljeno.');
        loadOrders();
      } catch (err) {
        console.error(err);
        alert('Napaka pri posodabljanju naročila. Preverite konzolo.');
      }
    }

    async function order() {
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const address = document.getElementById("address").value.trim();
      const service = document.getElementById("service").value;

      if (!name) return alert("Please enter your name.");
      if (!email || !isValidEmail(email)) return alert("Please enter a valid email address.");
      if (!phone || !isValidPhone(phone)) return alert("Please enter a valid phone number.");
      if (!address) return alert("Please enter your address.");

      try {
        const res = await fetch("/order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, phone, address, service })
        });
        if (!res.ok) {
          const err = await res.json().catch(() => null);
          throw new Error(err && err.error ? err.error : 'Server error');
        }
        const data = await res.json();
        alert(data.message || "Order placed!");
        document.getElementById("name").value = '';
        document.getElementById("email").value = '';
        document.getElementById("phone").value = '';
        document.getElementById("address").value = '';
        loadOrders();
      } catch (err) {
        console.error(err);
        alert("Failed to place order. See console for details.");
      }
    }

    document.getElementById("placeOrder").addEventListener("click", order);

    // Initial load
    loadOrders();
  </script>
</body>
</html>

